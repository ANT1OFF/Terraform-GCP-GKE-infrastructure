definitions:
  steps:
    - step: &terraform-test
        name: Testing terraform configuration
        image: hashicorp/terraform
        script:
            - cd ./terraform/dev/

            # hacky fix https://github.com/terraform-providers/terraform-provider-kubernetes/issues/679
            # !!!!
            #- export KUBERNETES_SERVICE_HOST=
            # !!!!

            - echo ${GCP_SECRET} > credentials.json
            - echo ${PROXY_SECRET} > proxyCreds.json
            - cd ../scripts/
            - /bin/sh tf-init.sh



    - step: &terraform-deploy
        name: Deploying terraform configuration
        image: kiwigrid/gcloud-kubectl-helm
        script:

            - cd ./terraform/dev/
            - echo ${GCP_SECRET} > credentials.json
            - gcloud auth activate-service-account --key-file=credentials.json
            - echo ${PROXY_SECRET} > proxyCreds.json

            # hacky fix https://github.com/terraform-providers/terraform-provider-kubernetes/issues/679
            # !!!!
            #- export KUBERNETES_SERVICE_HOST=
            # !!!!

            - cd /tmp/
            - wget https://releases.hashicorp.com/terraform/0.12.21/terraform_0.12.21_linux_amd64.zip
            - unzip terraform_0.12.21_linux_amd64.zip
            - export PATH="$PATH:/bin"

            - cd ${BITBUCKET_CLONE_DIR}/terraform/scripts/
            - /bin/bash tf-init.sh
            - /bin/bash tf-apply.sh
              

pipelines:
    default:
      - step: *terraform-test

    branches:
        master:
            - step: *terraform-test
            - step: *terraform-deploy
              
            
